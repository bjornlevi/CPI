<!doctype html>
<html lang="is">
<head>
  <meta charset="utf-8">
  <title>CPI – {{ site_name }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="stylesheet" href="{{ url_for('static', filename='app.css') }}">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="{{ url_for('static', filename='js/charts.js') }}?v=15"></script>

</head>
<body>
<header class="topbar">
  <div class="wrap"><h1 class="brand">VNV (CPI)</h1></div>
</header>

<main class="wrap">
  <section class="card card--chart">
    <div class="card-body">
      <div class="rowhead">
        <h2>Heildarvísitala + undirliðir</h2>
        <small class="muted">Síðast uppfært: {{ updated }}</small>
      </div>

      <div class="range-controls" data-chart="cpiChart">
        <div class="range-buttons">
          <button type="button" data-range="2y"  class="is-active">2 ár</button>
          <button type="button" data-range="5y">5 ár</button>
          <button type="button" data-range="10y">10 ár</button>
          <button type="button" data-range="all">Allt</button>
        </div>

        <div class="range-window">
          <!-- left handle (start) -->
          <input id="cpiChart-win-start" type="range" min="0" step="1">
          <!-- right handle (end) -->
          <input id="cpiChart-win-end"   type="range" min="1" step="1" class="is-end">
          <div class="range-labels">
            <span id="cpiChart-win-start-label">—</span>
            <span id="cpiChart-win-end-label">—</span>
          </div>
        </div>

        <label class="muted small" style="display:inline-flex;gap:.5rem;align-items:center;margin-top:.25rem">
          <input id="cpiChart-norm-toggle" type="checkbox">
          Normalisera (100 við upphaf glugga)
        </label>
      </div>

      <div class="chart-box chart-box--md">
        <canvas id="cpiChart"></canvas>
      </div>
      
      <div class="rowfoot">
        <span id="cpiChart-net" class="muted small"></span>
        <ul id="cpiChart-net-all" class="pill-list"></ul>
      </div>

      <div class="stat-card" style="margin-top:1rem">
        <div class="stat-card__title">Samantekt – VNV</div>
        <table class="stats">
          <thead>
            <tr>
              <th>Breyt­ing</th>
              <th>Meðaltal (saga)</th>
              <th>Miðgildi (saga)</th>
              <th>Núverandi</th>
              <th>Spá (næstu {{ cpi_table.monthly.horizon }})</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Mánaðar</td>
              <td>{{ cpi_table.monthly.historic_avg is not none and ('%.2f'|format(cpi_table.monthly.historic_avg)) ~ '%' or '—' }}</td>
              <td>{{ cpi_table.monthly.historic_med is not none and ('%.2f'|format(cpi_table.monthly.historic_med)) ~ '%' or '—' }}</td>
              <td>{{ cpi_table.monthly.current    is not none and ('%.2f'|format(cpi_table.monthly.current))    ~ '%' or '—' }}</td>
              <td>
                {{ cpi_table.monthly.projected_avg is not none and ('%.2f'|format(cpi_table.monthly.projected_avg)) ~ '%' or '—' }}
                <small class="muted">/ miðg. {{ cpi_table.monthly.projected_med is not none and ('%.2f'|format(cpi_table.monthly.projected_med)) ~ '%' or '—' }}</small>
              </td>
            </tr>
            <tr>
              <td>Árleg</td>
              <td>{{ cpi_table.yearly.historic_avg is not none and ('%.2f'|format(cpi_table.yearly.historic_avg)) ~ '%' or '—' }}</td>
              <td>{{ cpi_table.yearly.historic_med is not none and ('%.2f'|format(cpi_table.yearly.historic_med)) ~ '%' or '—' }}</td>
              <td>{{ cpi_table.yearly.current     is not none and ('%.2f'|format(cpi_table.yearly.current))     ~ '%' or '—' }}</td>
              <td>{{ cpi_table.yearly.projected   is not none and ('%.2f'|format(cpi_table.yearly.projected))   ~ '%' or '—' }}</td>
            </tr>
          </tbody>
        </table>
      </div>
      <!-- === /RESTORED === -->

      <!-- Movers (sortable) -->
      <div class="stat-card" style="margin-top:1rem">
        <div class="stat-card__title">Undirliðir sem hreyfðust mest nýlega</div>

        <table class="stats stats--sortable" id="subTable">
          <thead>
            <tr>
              <th data-key="label">Liður</th>
              <th data-key="mom"   class="num" aria-sort="none">Mán %</th>
              <th data-key="yoy"   class="num" aria-sort="descending">Ár %</th>
              <th data-key="d_mom" class="num" aria-sort="none">ΔM (pp)</th>
              <th data-key="d_yoy" class="num" aria-sort="none">ΔÁ (pp)</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <script>
      (function () {
        const DATA = {{ cpi_movers|default([])|tojson }};
        const tbody = document.querySelector('#subTable tbody');

        const fmtPct = v => (v == null ? '—' : `${v.toFixed(2)}%`);
        const fmtPP  = v => (v == null ? '—' : `${v.toFixed(2)}pp`);
        const cls    = v => (v == null ? '' : (v >= 0 ? 'pos' : 'neg'));

        function render(sortKey = 'yoy', dir = 'desc') {
          const sorted = [...DATA].sort((a, b) => {
            const va = a[sortKey], vb = b[sortKey];
            if (va == null && vb == null) return 0;
            if (va == null) return 1;
            if (vb == null) return -1;
            return dir === 'desc' ? (vb - va) : (va - vb);
          });

          tbody.innerHTML = sorted.map(r => `
            <tr>
              <td>${r.label || r.code}</td>
              <td class="num ${cls(r.mom)}">${fmtPct(r.mom)}</td>
              <td class="num ${cls(r.yoy)}">${fmtPct(r.yoy)}</td>
              <td class="num ${cls(r.d_mom)}">${fmtPP(r.d_mom)}</td>
              <td class="num ${cls(r.d_yoy)}">${fmtPP(r.d_yoy)}</td>
            </tr>
          `).join('');

          // update header aria-sort
          document.querySelectorAll('#subTable thead th').forEach(th => th.setAttribute('aria-sort','none'));
          const th = document.querySelector(`#subTable thead th[data-key="${sortKey}"]`);
          if (th) th.setAttribute('aria-sort', dir === 'desc' ? 'descending' : 'ascending');
        }

        document.querySelectorAll('#subTable thead th').forEach(th => {
          th.addEventListener('click', () => {
            const key = th.dataset.key;
            const current = th.getAttribute('aria-sort') || 'none';
            const nextDir = (current === 'descending') ? 'asc' : 'desc';
            render(key, nextDir);
          });
        });

        render('yoy', 'desc');
      })();
      </script>

    </div>
  </section>
</main>

<footer class="footer">
  <div class="wrap"><small class="muted"><a href="{{ url_for('index') }}">← Til baka</a></small></div>
</footer>

<!-- Chart init -->
<script>
  EconCharts.initCPIChart('cpiChart', {
    fullLabels: {{ full_labels|tojson }},
    fullValues: {{ full_values|tojson }},
    futLabels:  {{ fut_labels|tojson }},
    futValues:  {{ fut_values|tojson }},
    subMeta:    {{ cpi_sub_meta|tojson }},
    subSeries:  {{ cpi_sub_series|tojson }}, 
    initialRange: "5y"
  });
</script>
</body>
</html>
